---
title: "kotzeb0912: Get Data from Wildlife Computers Data Portal"
date: '`r Sys.Date()`'
output: bookdown::html_document2
params:
   get_data: FALSE
---

## Connect to Wildlife Computers Data Portal

Wildlife Computers (Redmond, Washington, USA) provides an API for their data
portal that allows us to download the latest telemetry data for any deployment. 
To facilitate connection and use of this API within R, the `wcUtils` package
has been developed.

The data portal is not a public repository. Data access is controlled by the
data owner. Thus, only those users who are either owners of the deployment 
data or users who have been granted access by the owner can access the API.

The `wcUtils` package is available for install from GitHub:

```{r install-wcutils}
if (!require('devtools')) install.packages('devtools')
if (!require('wcUtils')) {
  devtools::install_github('jmlondon/wcUtils')
}
if (!require('tidyverse')) install.packages('tidyverse')
```


## Download `kotzeb0912` Telemetry

All of the deployments have been labeled within the data portal as *ProjectID = KotzEB09*. We will use that information to only download the relevant data.

```{r get-data-from-wc, eval = as.logical(params$get_data)}
# first thing, get deployment data from WCDP
r <- wcUtils::wcPOST()
# get KotzEB09 ids and download the data
aleut_ids <- wcUtils::wcGetProjectIDs(r,project = 'KotzEB09')

for (i in 1:length(aleut_ids)) {
  zipfile <- wcUtils::wcGetZip(id = aleut_ids[i])
  file.copy(zipfile,'.',overwrite = TRUE)
  file.rename(file.path(basename(zipfile)),
              file.path(paste(aleut_ids[i],"zip",sep = '.'))
  )
}
```

The zip files downloaded from the data portal are named based on the 
unique id assigned within the data portal. For our deployments, we have 
assigned each a unique `DeployID`. It would be more informative if we could
rename all of these zip files to the assigned `DeployID`. Eventually, this
functionality could be implemented within the `wcUtils` package and the API,
but for now, we'll just open each zip file and examine the data files to
extract the assigned `DeployID`.

```{r rename-zip-files, eval = as.logical(params$get_data)}
for (zipfile in list.files(pattern = ".zip",full.names = TRUE)) {
  summary_name <- grep('*-Summary.csv',
                      unzip(file.path(
                                      basename(zipfile)),
                            list = TRUE)$Name,
                       value = TRUE)
  deployid <- read.csv(unzip(zipfile, files = summary_name))$DeployID
  deployid <- as.character(deployid)
  file.remove(summary_name)
  file.rename(file.path(zipfile),
              file.path(paste(deployid,"zip",sep = '.'))
  )
}
```

### List of Archive Files

```{r list-downloaded-files}
tibble(file_name = (list.files(pattern = ".zip"))) %>% knitr::kable()
```

## Establish Connection with DataONE Node

## Create datapack

## Send datapack to DataONE Node
